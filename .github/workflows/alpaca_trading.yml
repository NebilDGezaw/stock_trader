name: Alpaca Stock Trader

on:
  schedule:
    # ── LEVERAGED ETF ENTRIES (hourly during market hours, Mon-Fri) ──
    # Market hours: 9:30 AM - 4:00 PM ET = 14:30 - 21:00 UTC
    - cron: "30 14 * * 1-5"    # 9:30 AM ET — market open
    - cron: "30 15 * * 1-5"    # 10:30 AM ET
    - cron: "30 16 * * 1-5"    # 11:30 AM ET
    - cron: "30 17 * * 1-5"    # 12:30 PM ET
    - cron: "30 18 * * 1-5"    # 1:30 PM ET
    - cron: "30 19 * * 1-5"    # 2:30 PM ET
    - cron: "30 20 * * 1-5"    # 3:30 PM ET (last entry window)

    # ── GROWTH STOCK ENTRIES (every 2h, staggered) ──
    # tech + semis + clean_energy
    - cron: "35 14 * * 1-5"    # 9:35 AM ET — growth sectors
    - cron: "35 16 * * 1-5"    # 11:35 AM ET
    - cron: "35 18 * * 1-5"    # 1:35 PM ET
    - cron: "35 20 * * 1-5"    # 3:35 PM ET

    # ── DEFENSIVE STOCK ENTRIES (every 2h, staggered) ──
    # energy + consumer_staples + industrials + healthcare + consumer
    - cron: "40 14 * * 1-5"    # 9:40 AM ET — defensive sectors
    - cron: "40 16 * * 1-5"    # 11:40 AM ET
    - cron: "40 18 * * 1-5"    # 1:40 PM ET
    - cron: "40 20 * * 1-5"    # 3:40 PM ET

    # ── MONITOR (hourly during market hours) ──
    - cron: "0 15 * * 1-5"     # 10:00 AM ET
    - cron: "0 16 * * 1-5"     # 11:00 AM ET
    - cron: "0 17 * * 1-5"     # 12:00 PM ET
    - cron: "0 18 * * 1-5"     # 1:00 PM ET
    - cron: "0 19 * * 1-5"     # 2:00 PM ET
    - cron: "0 20 * * 1-5"     # 3:00 PM ET

    # ── EOD SUMMARY ──
    - cron: "15 21 * * 1-5"    # 4:15 PM ET — right after close

  workflow_dispatch:
    inputs:
      mode:
        description: "Trading mode"
        required: true
        default: "verify"
        type: choice
        options: [entry, monitor, summary, verify]
      session:
        description: "Session (for entry mode)"
        required: false
        default: "leveraged"
        type: choice
        options: [leveraged, tech, semis, healthcare, energy, consumer_staples, industrials, clean_energy, consumer, stocks]
      dry_run:
        description: "Dry run (no real orders)"
        required: false
        default: true
        type: boolean

# Reusable env block
env:
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
  ALPACA_PAPER: ${{ secrets.ALPACA_PAPER }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  # ═══════════════════════════════════════════════════════
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.inputs.mode == 'verify'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Verify Assets"
        run: python -m trading.run_alpaca --mode verify

  # ═══════════════════════════════════════════════════════
  #  LEVERAGED ETF ENTRIES (hourly)
  # ═══════════════════════════════════════════════════════

  leveraged-entry:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event.schedule == '30 14 * * 1-5' ||
      github.event.schedule == '30 15 * * 1-5' ||
      github.event.schedule == '30 16 * * 1-5' ||
      github.event.schedule == '30 17 * * 1-5' ||
      github.event.schedule == '30 18 * * 1-5' ||
      github.event.schedule == '30 19 * * 1-5' ||
      github.event.schedule == '30 20 * * 1-5' ||
      (github.event.inputs.mode == 'entry' && github.event.inputs.session == 'leveraged')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Leveraged ETF Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session leveraged $DRYRUN_FLAG

  # ═══════════════════════════════════════════════════════
  #  GROWTH SECTORS: TECH + SEMIS + CLEAN ENERGY (every 2h)
  # ═══════════════════════════════════════════════════════

  growth-entry:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: >-
      github.event.schedule == '35 14 * * 1-5' ||
      github.event.schedule == '35 16 * * 1-5' ||
      github.event.schedule == '35 18 * * 1-5' ||
      github.event.schedule == '35 20 * * 1-5' ||
      (github.event.inputs.mode == 'entry' && (github.event.inputs.session == 'tech' || github.event.inputs.session == 'semis' || github.event.inputs.session == 'clean_energy' || github.event.inputs.session == 'stocks'))
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Tech Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session tech $DRYRUN_FLAG
      - name: "Semis Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session semis $DRYRUN_FLAG
      - name: "Clean Energy Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session clean_energy $DRYRUN_FLAG

  # ═══════════════════════════════════════════════════════
  #  DEFENSIVE SECTORS: ENERGY + STAPLES + INDUSTRIALS +
  #  HEALTHCARE + CONSUMER (every 2h)
  #
  #  These are the CRASH HEDGES — they go UP or stay flat
  #  when tech crashes.  This job is what makes the system
  #  smart about sector rotation.
  # ═══════════════════════════════════════════════════════

  defensive-entry:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: >-
      github.event.schedule == '40 14 * * 1-5' ||
      github.event.schedule == '40 16 * * 1-5' ||
      github.event.schedule == '40 18 * * 1-5' ||
      github.event.schedule == '40 20 * * 1-5' ||
      (github.event.inputs.mode == 'entry' && (github.event.inputs.session == 'healthcare' || github.event.inputs.session == 'energy' || github.event.inputs.session == 'consumer_staples' || github.event.inputs.session == 'industrials' || github.event.inputs.session == 'consumer' || github.event.inputs.session == 'stocks'))
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Energy Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session energy $DRYRUN_FLAG
      - name: "Consumer Staples Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session consumer_staples $DRYRUN_FLAG
      - name: "Industrials Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session industrials $DRYRUN_FLAG
      - name: "Healthcare Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session healthcare $DRYRUN_FLAG
      - name: "Consumer Entry"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode entry --session consumer $DRYRUN_FLAG

  # ═══════════════════════════════════════════════════════
  #  MONITOR (hourly during market hours)
  # ═══════════════════════════════════════════════════════

  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event.schedule == '0 15 * * 1-5' ||
      github.event.schedule == '0 16 * * 1-5' ||
      github.event.schedule == '0 17 * * 1-5' ||
      github.event.schedule == '0 18 * * 1-5' ||
      github.event.schedule == '0 19 * * 1-5' ||
      github.event.schedule == '0 20 * * 1-5' ||
      github.event.inputs.mode == 'monitor'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Monitor Positions"
        run: |
          DRYRUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            DRYRUN_FLAG="--dry-run"
          fi
          python -m trading.run_alpaca --mode monitor $DRYRUN_FLAG

  # ═══════════════════════════════════════════════════════
  #  EOD SUMMARY
  # ═══════════════════════════════════════════════════════

  eod-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: >-
      github.event.schedule == '15 21 * * 1-5' ||
      github.event.inputs.mode == 'summary'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install packages
        run: pip install alpaca-py yfinance pandas numpy
      - name: "Monitor + Summary"
        run: |
          python -m trading.run_alpaca --mode monitor
          python -m trading.run_alpaca --mode summary
